<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Report - PJM</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    .report { background: white; padding: 20px; border: 1px solid #ccc; width: 900px; margin: auto; }
    .section { margin-top: 15px; border: 1px solid #aaa; padding: 10px; }
    .row { display: flex; justify-content: space-between; margin: 5px 0; }
    label { display: inline-block; width: 150px; margin: 3px 0; }
    input, textarea { width: calc(100% - 160px); padding: 3px; margin: 3px 0; }
    input[type="datetime-local"] { width: auto; }
    .signature-box { width: 300px; height: 100px; border: 1px solid #000; cursor: pointer; margin: auto; }
    .signature-preview { width: 100%; height: 100%; object-fit: contain; }
    .download-btn { display: block; margin: 20px auto; padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px; text-align: center;
    }
    canvas { border: 1px solid #000; cursor: crosshair; }
    button { margin: 5px; padding: 8px 15px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="report" id="report">
    <h2 style="text-align:center;">PJM SERVICE REPORT</h2>

    <!-- Customer Information -->
    <div class="section">
      <div class="row" style="align-items: center;">
        <p style="flex:1"><b>Customer Information</b></p>
        <div>
          <label>No.</label>
          <input type="text" class="small-input">
        </div>
      </div>
      <div class="row">
        <div style="width:48%">
          <label>Nama</label><input type="text"><br>
          <label>Department</label><input type="text"><br>
        </div>
        <div style="width:48%">
          <label>Address</label><input type="text"><br>
          <label>Contact Person</label><input type="text"><br>
        </div>
      </div>
    </div>

    <!-- Service Status & Equipment Information -->
    <div class="section">
      <div class="row" style="gap:10px;">
        <div style="width:48%; border:1px solid #000; padding:5px;">
          <p><b>Service Status (Customer)</b></p>
          <label><input type="checkbox"> Contract Service</label><br>
          <label><input type="checkbox"> Warranty</label><br>
          <label><input type="checkbox"> Solved</label><br><br>
          <p><b>CUSTOMER</b></p>
          <label>Request By</label><input type="text" id="requestBy"><br>
          <label>Date/Time</label><input type="datetime-local"><br>
        </div>
        <div style="width:48%; border:1px solid #000; padding:5px;">
          <p><b>Equipment Information</b></p>
          <label>Brand</label><input type="text"><br>
          <label>Equipment</label><input type="text"><br>
          <label>Model</label><input type="text"><br>
          <label>Type</label><input type="text"><br>
          <label>Serial No.</label><input type="text"><br>
          <label>Software Ver</label><input type="text"><br>
          <label>Part No.</label><input type="text"><br>
          <hr>
          <p><b>Engineer / Electromedical</b></p>
          <label>Completed By</label><input type="text" id="engineerName"><br>
          <label>Date/Time</label><input type="datetime-local"><br>
        </div>
      </div>
    </div>

    <!-- Customer Request -->
    <div class="section">
      <div class="section-title">Customer Request / Complain</div>
      <textarea rows="3"></textarea>
    </div>

    <!-- Service Description -->
    <div class="section">
      <div class="section-title">Service Description</div>
      <textarea rows="5"></textarea>
    </div>

    <!-- Kepuasan -->
    <div class="section">
      <div class="section-title">Penilaian Kepuasan Pelanggan</div>
      <table style="width:100%; border-collapse:collapse;" border="1">
        <tr>
          <td>1</td><td>2</td><td>3</td><td>4</td><td>5</td>
        </tr>
        <tr>
          <td colspan="2">Tidak Puas</td>
          <td></td>
          <td colspan="2">Puas</td>
        </tr>
      </table>
    </div>

    <!-- Tanda Tangan -->
    <div class="section">
      <div class="row" style="text-align:center; margin-top:30px;">
        <div style="width:45%">
          <p><b>Customer</b></p>
          <div id="sigCustomerBox" class="signature-box">
            <img id="sigCustomerImg" class="signature-preview">
          </div>
          <p>( <span id="customerSignName">______________________</span> )</p>
        </div>
        <div style="width:45%">
          <p><b>Engineer / Electromedical</b></p>
          <div id="sigEngineerBox" class="signature-box">
            <img id="sigEngineerImg" class="signature-preview">
          </div>
          <p>( <span id="engineerSignName">______________________</span> )</p>
        </div>
      </div>
    </div>
  </div>

  <button class="download-btn" id="download">Download PDF</button>

  <!-- Modal tanda tangan -->
  <div id="signatureModal" class="modal">
    <div class="modal-content">
      <h3>Gambar Tanda Tangan</h3>
      <canvas id="signaturePad" width="500" height="200"></canvas><br>
      <button id="clearBtn">Clear</button>
      <button id="saveBtn">Selesai</button>
      <button id="closeBtn">Batal</button>
    </div>
  </div>

  <script>
    // === Modal Signature Logic ===
    let currentTarget = null;
    const modal = document.getElementById("signatureModal");
    const canvas = document.getElementById("signaturePad");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function openModal(target) {
      currentTarget = target;
      modal.style.display = "flex";
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function closeModal() {
      modal.style.display = "none";
      currentTarget = null;
    }

    canvas.addEventListener("mousedown", e => {
      drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY);
    });
    canvas.addEventListener("mousemove", e => {
      if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }
    });
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseleave", () => drawing = false);

    document.getElementById("clearBtn").addEventListener("click", () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
    document.getElementById("saveBtn").addEventListener("click", () => {
      if (currentTarget) {
        const dataURL = canvas.toDataURL("image/png");
        document.getElementById(currentTarget + "Img").src = dataURL;
      }
      closeModal();
    });
    document.getElementById("closeBtn").addEventListener("click", closeModal);

    document.getElementById("sigCustomerBox").addEventListener("click", () => openModal("sigCustomer"));
    document.getElementById("sigEngineerBox").addEventListener("click", () => openModal("sigEngineer"));

    // Auto isi nama
    document.getElementById("requestBy").addEventListener("input", function() {
      document.getElementById("customerSignName").textContent = this.value || "______________________";
    });
    document.getElementById("engineerName").addEventListener("input", function() {
      document.getElementById("engineerSignName").textContent = this.value || "______________________";
    });

    // === Download PDF ===
    document.getElementById('download').addEventListener('click', () => {
      const report = document.querySelector('.report');
      html2canvas(report, { scale: 2, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgWidth = pageWidth - 20;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        pdf.save('PJM-Service-Report.pdf');
      });
    });
  </script>
</body>
</html>
