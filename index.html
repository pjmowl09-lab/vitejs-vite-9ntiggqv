<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PJM Service Report</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    .report { background: white; padding: 20px; border: 1px solid #ccc; width: 900px; margin: auto; }
    h2 { text-align: center; margin-bottom: 10px; }
    .section { margin-top: 15px; border: 1px solid #aaa; padding: 10px; }
    .section-title { font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #aaa; padding-bottom: 3px; }
    label { display: inline-block; width: 150px; margin: 3px 0; }
    input, textarea, select { width: calc(100% - 160px); padding: 3px; margin: 3px 0; }
    input[type="checkbox"], input[type="radio"] { width: auto; margin-right: 5px; }
    .row { display: flex; justify-content: space-between; margin: 5px 0; }
    .small-input { width: 100px !important; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #000; }
    td { padding: 5px; text-align: center; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .logo-block img { height: 80px; }
    .slogan { margin: 0; font-size: 12px; text-align: center; }
    .title { margin: 0 auto; text-align: center; flex: 1; }
    .title h2 { font-size: 28px; margin: 0; }
    .download-btn { display: block; margin: 20px auto; padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; }
    .signature-box { width: 300px; height: 100px; border: 1px dashed #555; margin: auto; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
    .signature-box img { max-width: 100%; max-height: 100%; display: block; }
    .signature-box .placeholder { color: #777; font-size: 14px; position: absolute; }
    /* Modal tanda tangan */
    #signatureModal { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000; }
    #signatureModal .modal-content { background:#fff; padding:20px; border-radius:8px; text-align:center; }
    #signaturePad { border:1px solid #000; }
    .modal-buttons { margin-top: 10px; }
    .modal-buttons button { margin: 0 5px; padding: 5px 15px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="report" id="report">
    <!-- Header -->
    <div class="header">
      <div class="logo-block">
        <img src="https://res.cloudinary.com/dctn5devk/image/upload/v1756081418/logo-pjm_ggsluh.png" alt="LogoPJM">
        <p class="slogan">We Come To Bring Change<br>Kami datang membawa perubahan</p>
      </div>
      <div class="title"><h2>PJM SERVICE REPORT</h2></div>
    </div>

    <!-- Customer Information -->
    <div class="section">
      <div class="row" style="align-items: center;">
        <p style="flex:1"><b>Customer Information</b></p>
        <div><label>No.</label><input type="text" class="small-input"></div>
      </div>
      <div class="row">
        <div style="width:48%">
          <label>Name</label><input type="text"><br>
          <label>Department</label><input type="text"><br>
        </div>
        <div style="width:48%">
          <label>Address</label><input type="text"><br>
          <label>Contact Person</label><input type="text"><br>
        </div>
      </div>
    </div>

    <!-- Service Status & Equipment Information -->
    <div class="section">
      <div class="row" style="gap:10px;">
        <div style="width:48%; border:1px solid #000; padding:5px;">
          <p><b>Service Status (Customer)</b></p>
          <label><input type="checkbox"> Contract Service</label><br>
          <label><input type="checkbox"> Warranty</label><br>
          <label><input type="checkbox"> Solved</label><br>
          <br><br><br><br>
          <p><b>CUSTUMER</b></p>
          <label>Request By</label><input type="text" id="requestBy"><br>
          <label>Date/Time</label><input type="datetime-local"><br>
        </div>
        <div style="width:48%; border:1px solid #000; padding:5px;">
          <p><b>Equipment Information</b></p>
          <label>Brand</label><input type="text"><br>
          <label>Equipment</label><input type="text"><br>
          <label>Model</label><input type="text"><br>
          <label>Type</label><input type="text"><br>
          <label>Serial No.</label><input type="text"><br>
          <label>Software Ver</label><input type="text"><br>
          <label>Part No.</label><input type="text"><br>
          <hr>
          <p><b>Engineer / Electromedical</b></p>
          <label>Completed By</label><input type="text" id="engineerName"><br>
          <label>Date/Time</label><input type="datetime-local"><br>
        </div>
      </div>
    </div>

    <!-- Customer Request -->
    <div class="section">
      <div class="section-title">Customer Request / Complain</div>
      <textarea rows="3"></textarea>
    </div>

    <!-- Service Description -->
    <div class="section">
      <div class="section-title">Service Description</div>
      <textarea rows="5"></textarea>
    </div>

    <!-- Kepuasan -->
    <div class="section">
      <div class="section-title">Penilaian Kepuasan Pelanggan</div>
      <table>
        <tr><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td></tr>
        <tr><td colspan="2">Tidak Puas</td><td></td><td colspan="3">Puas</td></tr>
      </table>
    </div>

    <!-- Tanda Tangan -->
    <div class="section">
      <div class="row" style="text-align:center; margin-top:30px;">
        <div style="width:45%">
          <p><b>Customer</b></p>
          <div id="sigCustomerBox" class="signature-box">
            <span class="placeholder">Klik untuk tanda tangan</span>
            <img id="sigCustomerImg" class="signature-preview">
          </div>
          <p>( <span id="customerSignName">______________________</span> )</p>
        </div>
        <div style="width:45%">
          <p><b>Engineer / Electromedical</b></p>
          <div id="sigEngineerBox" class="signature-box">
            <span class="placeholder">Klik untuk tanda tangan</span>
            <img id="sigEngineerImg" class="signature-preview">
          </div>
          <p>( <span id="engineerSignName">______________________</span> )</p>
        </div>
      </div>
    </div>
  </div>

  <button class="download-btn" id="download">Download PDF</button>

  <!-- Modal tanda tangan -->
  <div id="signatureModal">
    <div class="modal-content">
      <p>Silakan tanda tangan</p>
      <canvas id="signaturePad" width="400" height="200"></canvas>
      <div class="modal-buttons">
        <button id="clearBtn">Clear</button>
        <button id="saveBtn">Selesai</button>
        <button id="closeBtn">Batal</button>
      </div>
    </div>
  </div>

  <script>
    // ====== PDF Export ======
    document.getElementById('download').addEventListener('click', () => {
      const report = document.querySelector('.report');
      html2canvas(report, { scale: 2, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgWidth = pageWidth - 20;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        pdf.save('PJM-Service-Report.pdf');
      });
    });

    // ====== Signature Modal ======
    let currentTarget = null;
    const modal = document.getElementById("signatureModal");
    const canvas = document.getElementById("signaturePad");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function openModal(target) {
      currentTarget = target;
      modal.style.display = "flex";
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function closeModal() {
      modal.style.display = "none";
      currentTarget = null;
    }

    // Mouse events
    canvas.addEventListener("mousedown", e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    canvas.addEventListener("mousemove", e => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseleave", () => drawing = false);

    // Touch events (mobile)
    function getTouchPos(canvasDom, touchEvent) {
      const rect = canvasDom.getBoundingClientRect();
      return { x: touchEvent.touches[0].clientX - rect.left, y: touchEvent.touches[0].clientY - rect.top };
    }
    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      const touchPos = getTouchPos(canvas, e);
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(touchPos.x, touchPos.y);
    });
    canvas.addEventListener("touchmove", e => {
      e.preventDefault();
      if (drawing) {
        const touchPos = getTouchPos(canvas, e);
        ctx.lineTo(touchPos.x, touchPos.y);
        ctx.stroke();
      }
    });
    canvas.addEventListener("touchend", e => { e.preventDefault(); drawing = false; });

    // Buttons
    document.getElementById("clearBtn").addEventListener("click", () => ctx.clearRect(0, 0, canvas.width, canvas.height));
    document.getElementById("saveBtn").addEventListener("click", () => {
      if (currentTarget) {
        const dataURL = canvas.toDataURL("image/png");
        const img = document.getElementById(currentTarget + "Img");
        const placeholder = document.querySelector("#" + currentTarget + "Box .placeholder");
        img.src = dataURL;
        if (placeholder) placeholder.style.display = "none"; // sembunyikan tulisan
      }
      closeModal();
    });
    document.getElementById("closeBtn").addEventListener("click", closeModal);

    // Open modal
    document.getElementById("sigCustomerBox").addEventListener("click", () => openModal("sigCustomer"));
    document.getElementById("sigEngineerBox").addEventListener("click", () => openModal("sigEngineer"));

    // Auto isi nama
    document.getElementById("requestBy").addEventListener("input", function() {
      document.getElementById("customerSignName").textContent = this.value || "______________________";
    });
    document.getElementById("engineerName").addEventListener("input", function() {
      document.getElementById("engineerSignName").textContent = this.value || "______________________";
    });
  </script>
</body>
</html>
